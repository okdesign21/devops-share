title AWS Infrastructure - Dev Environment
direction right

// ── External Services ──
Developer [icon: user, label: "Developer\n(IAM authenticated)"]
Internet [icon: cloud, label: "Internet"]
Cloudflare [icon: cloudflare, label: "Cloudflare DNS\ninfinity.ortflix.uk"]
DockerHub [icon: docker, label: "Docker Hub"]

// ── AWS Services ──
SSM_Service [icon: aws-systems-manager, label: "AWS Systems Manager\nSession Manager"]
Route53_Public [icon: aws-route-53, label: "Route53 Public Zone\nr53.infinity.ortflix.uk"]
Route53_Private [icon: aws-route-53, label: "Route53 Private Zone\ninternal.local"]
ACM [icon: aws-certificate-manager, label: "ACM Certificate\n*.dev.r53.infinity.ortflix.uk"]

Main_VPC [label: "VPC: 10.10.0.0/16 (proj-dev)", icon: aws-vpc] {
  
  InternetGateway [icon: aws-internet-gateway, label: "Internet Gateway"]
  Public_RT [icon: aws-route-table, label: "Public Route Table"]
  Private_RT [icon: aws-route-table, label: "Private Route Table"]

  // ── AZ eu-central-1a ──
  "AZ eu-central-1a" {
    Public_Subnet_A [label: "Public Subnet\n10.10.1.0/24"] {
      NAT_Instance [icon: aws-ec2, label: "NAT Instance\nt3.micro\nSG: ssm_only + nat\nPublic IP: 18.194.41.61"]
    }

    Private_Subnet_A [label: "Private Subnet\n10.10.11.0/24"] {
      GitLab_Server [icon: gitlab, label: "GitLab Server\nt3.medium\nSG: ssm_only\nPrivate IP: 10.10.12.43\nDocker: gitlab/gitlab-ce"]
      Jenkins_Server [icon: jenkins, label: "Jenkins Server\nt3.medium\nSG: ssm_only\nPrivate IP: 10.10.11.72\nDocker: jenkins/jenkins"]
      
      EKS_Node_A [icon: aws-eks-node, label: "EKS Node Group A\nt3.medium (x1)\nSG: eks_node\nPrivate subnet"]
    }
  }

  // ── AZ eu-central-1b ──
  "AZ eu-central-1b" {
    Public_Subnet_B [label: "Public Subnet\n10.10.2.0/24"] { }

    Private_Subnet_B [label: "Private Subnet\n10.10.12.0/24"] {
      EKS_Node_B [icon: aws-eks-node, label: "EKS Node Group B\nt3.medium (x1)\nSG: eks_node\nPrivate subnet"]
    }
  }

  // ── EKS Control Plane ──
  EKS_Cluster [icon: aws-eks, label: "EKS Cluster\nproj-dev-cluster\nv1.34\nPublic API endpoint"] {
    ALB_Controller [icon: kubernetes, label: "AWS Load Balancer\nController\n(IRSA)"]
    ExternalDNS [icon: kubernetes, label: "ExternalDNS\n(IRSA)"]
    App_Pods [icon: kubernetes, label: "Application Pods\n(Future)"]
  }
}

// ── Security Groups ──
SG_SSM [icon: aws-security-group, label: "SG: ssm_only\nIngress: VPC CIDR (all)\nEgress: All"]
SG_NAT [icon: aws-security-group, label: "SG: nat\nIngress: Private CIDRs\nEgress: All"]
SG_EKS_Cluster [icon: aws-security-group, label: "SG: eks_cluster\nManaged by EKS"]
SG_EKS_Node [icon: aws-security-group, label: "SG: eks_node\nIngress: 10250 (cluster)\nEgress: All"]

// ── IAM Roles ──
IAM_SSM_Role [icon: aws-iam, label: "IAM Instance Profile\nssm-instance-profile\n(EC2 SSM access)"]
IAM_ALB_Role [icon: aws-iam, label: "IRSA Role\nALB Controller\n(create ALBs)"]
IAM_DNS_Role [icon: aws-iam, label: "IRSA Role\nExternalDNS\n(manage Route53)"]
IAM_Devs_Group [icon: aws-iam, label: "IAM Group: Devs\nSSM Session Manager\nEKS access"]

// ══════════════════════════════════════════════════════════════════════════
// CONNECTIVITY
// ══════════════════════════════════════════════════════════════════════════

// ── Developer Access (SSM) ──
Developer > SSM_Service: "IAM auth" [color: blue]
SSM_Service > GitLab_Server: "Port-forward 80→8443" [color: blue]
SSM_Service > Jenkins_Server: "Port-forward 8080→8080" [color: blue]
SSM_Service > NAT_Instance: "Shell session" [color: blue]
Developer > IAM_Devs_Group: "Member of"

// ── Public Internet Flow ──
Internet > InternetGateway
InternetGateway > Public_Subnet_A
InternetGateway > Public_Subnet_B

// ── NAT Flow (Egress) ──
Private_Subnet_A > NAT_Instance: "Default route 0.0.0.0/0" [color: green]
Private_Subnet_B > NAT_Instance: "Default route 0.0.0.0/0" [color: green]
NAT_Instance > InternetGateway: "NAT to internet" [color: green]

// ── Route Tables ──
Public_Subnet_A > Public_RT
Public_Subnet_B > Public_RT
Private_Subnet_A > Private_RT
Private_Subnet_B > Private_RT

// ── CICD Internal Communication ──
Jenkins_Server > GitLab_Server: "HTTP via private DNS\ngitlab-server.internal.local" [color: orange]
EKS_Node_A > GitLab_Server: "HTTP port 80" [color: orange]
EKS_Node_B > GitLab_Server: "HTTP port 80" [color: orange]
EKS_Node_A > Jenkins_Server: "HTTP port 8080" [color: orange]
EKS_Node_B > Jenkins_Server: "HTTP port 8080" [color: orange]

// ── Private DNS Resolution ──
Route53_Private > GitLab_Server: "A record\ngitlab-server.internal.local\n→ 10.10.12.43"
Route53_Private > Jenkins_Server: "A record\njenkins-server.internal.local\n→ 10.10.11.72"
Route53_Private > Main_VPC: "Attached to VPC"

// ── EKS Control Plane ↔ Nodes ──
EKS_Cluster > EKS_Node_A: "Kubelet 10250" [color: purple]
EKS_Cluster > EKS_Node_B: "Kubelet 10250" [color: purple]

// ── Kubernetes Controllers ──
ALB_Controller > IAM_ALB_Role: "IRSA (create ALBs)"
ExternalDNS > IAM_DNS_Role: "IRSA (manage Route53)"
ExternalDNS > Route53_Public: "Create/update DNS records"

// ── DNS Delegation ──
Cloudflare > Route53_Public: "NS delegation"

// ── Certificate ──
ACM > Route53_Public: "DNS validation"

// ── External Dependencies ──
GitLab_Server > DockerHub: "Pull gitlab image" [color: green]
Jenkins_Server > DockerHub: "Pull jenkins image" [color: green]
EKS_Node_A > DockerHub: "Pull app images" [color: green]
EKS_Node_B > DockerHub: "Pull app images" [color: green]

// ── IAM Attachments ──
GitLab_Server > IAM_SSM_Role: "Instance profile"
Jenkins_Server > IAM_SSM_Role: "Instance profile"
NAT_Instance > IAM_SSM_Role: "Instance profile"

// ══════════════════════════════════════════════════════════════════════════
// NOTES
// ══════════════════════════════════════════════════════════════════════════

Architecture Highlights:
- SSM-only access (no bastion, no SSH keys)
- Private DNS for internal service discovery
- Custom NAT instance (~$7/mo vs $45/mo NAT Gateway)
- CICD in private subnets (GitLab + Jenkins)
- EKS with public API (restricted to admin IPs + NAT IP)
- IRSA for ALB Controller + ExternalDNS
- ACM certificate with DNS validation
- Route53 public zone delegated from Cloudflare

🔵 Blue arrows = Developer SSM access paths
🟢 Green arrows = Internet/NAT egress traffic
🟠 Orange arrows = Internal CICD communication (via private DNS)
🟣 Purple arrows = EKS control plane ↔ nodes
